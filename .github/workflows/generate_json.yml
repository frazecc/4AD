name: Generate JSON Index on Push

on:
  push:
    branches:
      - main
    paths:
      - 'images/**'

permissions:
  contents: write 

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: List files and generate JSON
        id: generate
        run: |
          # Questo script cerca i file in TUTTE le sottocartelle di images/
          echo "[" > files.json
          FIRST=true
          # Modifica: usa un pattern ricorsivo per trovare file in tutte le sottocartelle
          for file in images/**/*.{jpg,png,jpeg}; do
            if [ -e "$file" ]; then
              if [ "$FIRST" = "false" ]; then
                echo "," >> files.json
              fi
              
              FILENAME=$(basename "$file")
              # Estrae il nome della sottocartella (es. 'pg', 'nemici')
              DIRNAME=$(dirname "$file" | sed 's/images\///')
              
              # Usa il nome del file (senza estensione) come nome leggibile
              CLEAN_NAME=$(echo "$FILENAME" | sed -E 's/\.[^.]*$//' | tr '_' ' ') 
              
              # Crea l'oggetto JSON con il campo 'group'
              echo "  {" >> files.json
              echo "    \"name\": \"$CLEAN_NAME\"," >> files.json
              echo "    \"path\": \"$file\"," >> files.json
              echo "    \"group\": \"$DIRNAME\"" >> files.json
              echo "  }" >> files.json
              FIRST=false
            fi
          done
          echo "]" >> files.json

      - name: Commit and Push new files.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generated files.json index [skip ci]"
          file_pattern: 'files.json'
          skip_ci: true
