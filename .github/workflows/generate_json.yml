name: Generate JSON Index on Push

on:
  push:
    branches:
      - main
    paths:
      - 'images/**' # Avvia l'azione solo quando ci sono cambiamenti nella cartella images/

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: List files and generate JSON
        id: generate
        run: |
          # Trova tutti i file .jpg e .png nella cartella images/, ignorando le cartelle
          # Genera il JSON
          echo "[" > files.json
          FIRST=true
          for file in images/*.{jpg,png,jpeg}; do
            if [ -e "$file" ]; then
              if [ "$FIRST" = "false" ]; then
                echo "," >> files.json
              fi
              FILENAME=$(basename "$file")
              # Usa il nome del file (senza estensione) come nome leggibile (nome: "mappa_1")
              CLEAN_NAME=$(echo "$FILENAME" | sed -E 's/\.[^.]*$//' | tr '_' ' ') 
              
              # Crea l'oggetto JSON
              echo "  {" >> files.json
              echo "    \"name\": \"$CLEAN_NAME\"," >> files.json
              echo "    \"path\": \"$file\"" >> files.json
              echo "  }" >> files.json
              FIRST=false
            fi
          done
          echo "]" >> files.json

      - name: Commit and Push new files.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generated files.json index [skip ci]"
          file_pattern: 'files.json'
